<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../app-localize-behavior/app-localize-behavior.html">

<dom-module id="stv-variant-frequencies">
    <style is="custom-style"
           include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            width: 100%;
        }

        stv-table {
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
            overflow-y: hidden;
        }

        stv-table::shadow #list {
            min-height: 200px;
        }

        stv-table::shadow {
            font-size: 11px;
        }

        stv-table::shadow .table-row {
            height: 25px;
        }

        stv-table::shadow .table-header-field > .name.stv-table {
            padding: 4px 0;
        }

        #mafChart {
            border: 1px solid rgba(125, 125, 125, 0.4);
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            overflow-x: auto;
            height: 350px;
        }

    </style>
    <template>
        <div hidden$="{{isEmpty}}" class="horizontal layout wrap center-justified">
            <stv-table id="table" enable-export enable-paging></stv-table>
            <div id="mafChart" hidden></div>
        </div>
        <div hidden$="{{!isEmpty}}" style="padding:20px 50px;">
            No frequencies found.
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'stv-variant-frequencies',
        properties: {
            row: {
                type: Object,
                observer: 'rowChanged'
            },
            isEmpty: {
                value: false,
                type: Boolean
            },
            // localization
            language: {
                value: 'en'
            },
            resources: {
                type: Object,
                value: function() {
                    return {
                        'en': {},
                    };
                }
            }
        },
        // localization
        behaviors: [
            Polymer.AppLocalizeBehavior
        ],
        ready: function () {
            this.$.table.columns = this._columns;
        },
        _columns: [{
            name: "study",
            title: "Study",
            width: 150,
            disableTooltip: true,
            formula: function(row){
                return '<span title="'+ (row.descStudy != null ? row.descStudy : row.study) + '">' + row.study +'</span>';
            }
        }, {
            name: "population",
            title: "Population",
            width: 150,
            disableTooltip: true,
            formula: function(row){
                return '<span title="'+ (row.descPopulation != null ? row.descPopulation : row.population )+ '">' + row.population +'</span>';
            }
        }, {
            name: "refAllele",
            title: "Ref. Allele",
            width: 50
        }, {
            name: "altAllele",
            title: "Alt. Allele",
            width: 50
        }, {
            name: "refAlleleFreq",
            title: "Ref. Allele Freq.",
            cellTemplate: 'alleleFreqCT',
            formula: function (row) {
                var val = ".";
                if (row.refAlleleFreq != null) {
                    val = row.refAlleleFreq.toFixed(3);
                }
                return val;
            },
            width: 70
        }, {
            name: "altAlleleFreq",
            title: "Alt. Allele Freq.",
            formula: function (row) {
                var val = ".";
                if (row.altAlleleFreq != null) {
                    val = row.altAlleleFreq.toFixed(3);
                }
                return val;
            },
            width: 70
        }, {
            name: "maf",
            title: "MAF",
            formula: function (row) {
                return Math.min(row.refAlleleFreq, row.altAlleleFreq).toFixed(3);
            },
            width: 70
        }],
        rowChanged: function (neo, old) {
            var me = this;

            this.$.table.currentPage = 1;

            if (neo) {
                var variant = neo.chromosome + ":" + neo.start + ":" + neo.reference + ":" + neo.alternate;
                CellBaseManager.get({
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'variant',
                    resource: 'annotation',
                    query: variant,
                    //                    query: "19:45411941:T:C",
                    async: false,
                    success: function (response) {
                        try {
                            var result = response.response[0].result[0].populationFrequencies;
                            for (var i = 0; i < result.length; i++) {
                                me.language="en";
                                if (me.localize(result[i].study) != "" && me.localize(result[i].study) !=undefined) {
                                    result[i].descStudy = result[i].study + ": " + me.localize(result[i].study);
                                }

                                me.language=result[i].study;
                                if (me.localize(result[i].population) != "" && me.localize(result[i].population) != undefined) {
                                    result[i].descPopulation = result[i].population + ": " + me.localize(result[i].population);
                                }
                            }
                            me.$.table.data=result;
                            me.isEmpty = (me.$.table.data.length <= 0);
                        } catch (e) {
                            me.$.table.data = [];
                            me.isEmpty = true;
                        }
                    }
                });

                var data = [];
                var cat = [];
                for (var i = 0; i < me.$.table.data.length; i++) {
                    var elem = me.$.table.data[i];
                    var maf = parseFloat(Math.min(elem.refAlleleFreq, elem.altAlleleFreq).toFixed(3));
                    data.push(maf);
                    cat.push(elem.study + "/" + elem.population);
                }

                var polarChart = new Highcharts.Chart({
                    chart: {
                        polar: true,
                        renderTo: this.$.mafChart
                    },
                    credits: {
                        enabled: false
                    },
                    legend: {
                        enabled: false
                    },
                    title: {
                        text: "Minor Allele Frequency",
                        x: -80
                    },
                    xAxis: {
                        categories: cat,
                        tickmarkPlacement: 'on',
                        lineWidth: 1
                    },

                    yAxis: {
                        gridLineInterpolation: 'polygon',
                        lineWidth: 0,
                        max: 0.5
                    },

                    series: [{
                        type: 'area',
                        name: "MAF",
                        data: data,
                        pointPlacement: 'on'
                    }]

                });
                this.$.mafChart.hidden = false;
            }
        },
        //localization
        attached: function() {
           var elto = this.loadResources(this.resolveUrl('../../conf/locales.json'));
        },
    });
</script>
