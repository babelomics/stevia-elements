<link rel="import" href="../../../polymer/polymer.html">
<dom-module id="stv-variant-effect">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            width: 100%;
        }

        stv-table {
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
            overflow-y: hidden;
        }
        
        stv-table::shadow #list {
            min-height: 200px;
        }

        stv-table::shadow {
            font-size: 11px;
        }

        stv-table::shadow .table-row {
            height: 25px;
        }

        stv-table::shadow .table-header-field > .name.stv-table {
            padding: 4px 0;
        }
    </style>
    <template>
        <stv-table id="table" hidden$="{{isEmpty}}" on-rowclick="handleRowClick" enable-export enable-paging enable-resize></stv-table>
        <div hidden$="{{!isEmpty}}" style="padding:20px 50px;">
            No effect found.
        </div>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'stv-variant-effect',
        properties: {
            row: {
                type: Object,
                observer: 'rowChanged'
            },
            isEmpty: {
                value: false,
                type: Boolean
            }
        },
        ready: function() {
            this.$.table.columns = this._columns;
        },
        _columns: [{
                name: "geneName",
                title: "Gene Name",
                defaultValue: '.'
            }, {
                name: "ensemblGeneId",
                title: "Ensembl Gene Id",
                cellTemplate: "ensemblGeneIdTemplate",
                width: 150,
                defaultValue: '.',
		disableTooltip: true,
                formula: function(row){
                    if (row.ensemblGeneId != "." && row.ensemblGeneId != undefined){
                        return "<a class='link' href='http://grch37.ensembl.org/Homo_sapiens/Gene/Summary?g=" + row.ensemblGeneId  +"' target='_blank' " +
                            "title=" + row.ensemblGeneId  +">"+row.ensemblGeneId+"</a>";
                    } else
                        return ".";
                }
            }, {
                name: "ensemblTranscriptId",
                title: "Ensembl Transcript Id",
                cellTemplate: 'ensemblTranscriptIdTemplate',
                width: 150,
                defaultValue: '.',
                disableTooltip: true,
                formula: function(row){
                    if (row.ensemblTranscriptId != "." && row.ensemblTranscriptId != undefined){
                        return "<a class='link' href='http://grch37.ensembl.org/Homo_sapiens/Transcript/Summary?t=" + row.ensemblTranscriptId  +"' target='_blank' " +
                            "title=" + row.ensemblTranscriptId  +">"+row.ensemblTranscriptId+"</a>";
                    } else
                        return ".";
                }
            }, {
                name: "so",
                title: "Conseq. type",
                formula: function(row) {
                    var aux = {};
                    if (row.soName && row.soAccession) {

                        aux.soName = row.soName;
                        aux.soAccession = row.soAccession;
                    }
                    return aux.soName;
                },
                width: 300
            },
            {
                name: "codon",
                title: "Codon",
                width: 60,
                defaultValue: '.'
            }, {
                name: "strand",
                title: "Strand",
                defaultValue: '.'
            }, {
                name: "biotype",
                title: "Biotype",
                defaultValue: '.'
            }, {
                name: "cdnaPosition",
                title: "cDna Position",
                width: 80,
                defaultValue: '.'
            }, {
                name: "cdsPosition",
                title: "cds Position",
                width: 80,
                defaultValue: '.'
            },{
                name: "exonOverlap",
                title: "exon Overlap",
                formula: function(row) {
                    try {
                        var eo = row.exonOverlap;
                        var res = [];
                        if (eo != null && eo.length > 0) {
                            for (var i = 0; i < eo.length; i++) {
                                  if (!!eo[i].number)
                                      res.push(eo[i].number) ;
                            }
                        }
                        return res.length > 0 ? res.join() : ".";
                    } catch (e) {
                        return ".";
                    }
                }
            }, {
                name: "aaPosition",
                title: "AA Position",
                width: 80,
                formula: function(row) {
                    try {
                        var pva = row.proteinVariantAnnotation;
                        var res = (pva.position) ? pva.position : ".";
                        return res;
                    } catch (e) {
                        return ".";
                    }
                }
            }, {
                name: "aaChange",
                title: "AA Change",
                width: 80,
                formula: function(row) {
                    try {
                        var pva = row.proteinVariantAnnotation;
                        var res = pva.reference + " > " + pva.alternate;
                        return res;
                    } catch (e) {
                        return ".";
                    }
                }
            }, {
                name: "sift",
                title: "Sift",
                formula: function(row) {
                    var pva = row.proteinVariantAnnotation;
                    if (pva != null && Object.keys(pva).length > 0) {
                        var pss = pva.substitutionScores;
                        if (pss != null && pss.length > 0) {
                            for (var i = 0; i < pss.length; i++) {
                                var elem = pss[i];
                                if (elem.source.toLowerCase() == "sift") {
                                    return elem.score;
                                }
                            }
                        }
                    }
                    return ".";
                },
                width: 80
            }, {
                name: "polyphen",
                title: "Polyphen",
                formula: function(row) {
                    var pva = row.proteinVariantAnnotation;
                    if (pva != null && Object.keys(pva).length > 0) {
                        var pss = pva.substitutionScores;
                        if (pss != null && pss.length > 0) {
                            for (var i = 0; i < pss.length; i++) {
                                var elem = pss[i];
                                if (elem.source.toLowerCase() == "polyphen") {
                                    return elem.score;
                                }
                            }
                        }
                    }

                    return ".";
                },
                width: 100
            },{
                name: "HGVSc",
                title: "HGVSc",
                width: 200,
                defaultValue: ".",
                formula: function(row) {
                    try {
                        return !!row.hgvsc && row.hgvsc.length > 0 ? row.hgvsc.join(",") : ".";
                    } catch (e) {
                        return ".";
                    }
                }
            }, {
                name: "HGVSp",
                title: "HGVSp",
                width: 200,
                defaultValue: ".",
                formula: function(row) {
                    try {
                        return !!row.hgvsp && row.hgvsp.length > 0 ? row.hgvsp.join(",") : "." ;
                    } catch (e) {
                        return ".";
                    }
                }
            }, {
                name: "transcriptCanonical",
                title: "Canonical",
                width: 50,
                defaultValue: "."
            }
        ],

        rowChanged: function(neo, old) {
            var me = this;
            this.$.table.currentPage = 1;
            if (neo) {
                var variant = neo.chromosome + ":" + neo.start + ":" + neo.reference + ":" + neo.alternate;
                CellBaseManager.get({
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'variant',
                    resource: 'annotation',
                    query: variant,
                    paramsWS: {
                            transcripts: true
                         },
                    //                    query: "19:45411941:T:C",
                    async: false,
                    success: function(response) {
                        try {
                            me.$.table.data = me.parseFunction(response.response[0].result[0], neo);
                            me.isEmpty = (me.$.table.data.length > 0) ? false : true;
                        } catch (e) {
                            me.$.table.data = [];
                            me.isEmpty = true;
                        }
                    }
                });
            }
        },
        parseFunction: function(data, neo) {
            var res = [];
            var consequenceTypes = data.consequenceTypes;

            for (var i = 0; i < consequenceTypes.length; i++) {
                var elem = consequenceTypes[i];

                for (var j = 0; j < elem.sequenceOntologyTerms.length; j++) {
                    var soTerm = elem.sequenceOntologyTerms[j];
                    var aux = stv.utils.clone(elem);
                    aux.soName = soTerm.name;
                    aux.soAccession = soTerm.accession;

                    if (data.transcripts &&  data.transcripts != undefined) {
                        var trans = data.transcripts.filter(function (t){ return t.transcriptId == aux.ensemblTranscriptId});
                        if (trans != undefined && trans.length > 0) {
                            aux.hgvsc = trans[0].hgvsc;
                            aux.hgvsp = trans[0].hgvsp ;
                            aux.transcriptCanonical = !!trans[0].transcriptCanonical ? trans[0].transcriptCanonical : ".";
                        }
                    }

                    res.push(aux);
                }
            }
            return res;
        }
    });
</script>